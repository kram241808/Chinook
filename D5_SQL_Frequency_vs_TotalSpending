-- Identify customers with high frequency but low spending and low frequency but high spending.

SELECT c.CustomerId , c.FirstName, c.LastName, 
  SUM(i.Total) AS Customer_Total, 
  COUNT(i.invoiceId) AS Purchase_Count, 
CASE
    WHEN COUNT(invoiceId) > (SELECT AVG(CountPerCustomer) FROM 
        (SELECT COUNT(invoiceId) AS CountPerCustomer FROM invoices GROUP BY customerId))
    AND SUM(i.Total) < (SELECT AVG(TotalPerCustomer) FROM 
        (SELECT SUM(Total) AS TotalPerCustomer FROM invoices GROUP BY customerId))
    THEN 'High Frequent Low Spending'
    WHEN COUNT(invoiceId) < (SELECT AVG(CountPerCustomer) FROM 
        (SELECT COUNT(invoiceId) AS CountPerCustomer FROM invoices GROUP BY customerId))
    AND SUM(i.Total) > (SELECT AVG(TotalPerCustomer) FROM 
        (SELECT SUM(Total) AS TotalPerCustomer FROM invoices GROUP BY customerId))
    THEN 'High Frequent Low Spending'
END AS Customer_Segment
FROM invoices i
LEFT JOIN customers c
ON i.customerId = c.customerId
GROUP BY i.customerId

